
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>neurodent.core.utils &#8212; Neurodent 0.2.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=938c9ccc"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/neurodent/core/utils';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://josephdong1000.github.io/neurodent/_static/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '0.2.0';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Neurodent</p>
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../installation/index.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../quickstart/index.html">
    Quickstart
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api/index.html">
    API Reference
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../contributing/index.html">
    Contributing
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../license/index.html">
    License
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/josephdong1000/neurodent" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/neurodent/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../installation/index.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../quickstart/index.html">
    Quickstart
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../contributing/index.html">
    Contributing
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../license/index.html">
    License
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/josephdong1000/neurodent" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/neurodent/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">neurodent.core.utils</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for neurodent.core.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">dateutil.parser</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dateutil.parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParserError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KDTree</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">mne</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">mne.io.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">FIFF</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover - optional at import time for tests not using MNE</span>
    <span class="n">mne</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">FIFF</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span>


<div class="viewcode-block" id="convert_units_to_multiplier">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.convert_units_to_multiplier">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_units_to_multiplier</span><span class="p">(</span><span class="n">current_units</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;µV&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert between different voltage units and return the multiplication factor.</span>

<span class="sd">    This function calculates the conversion factor needed to transform values</span>
<span class="sd">    from one voltage unit to another (e.g., from mV to µV).</span>

<span class="sd">    Args:</span>
<span class="sd">        current_units (str): The current unit of the values. Must be one of: &#39;µV&#39;, &#39;mV&#39;, &#39;V&#39;, &#39;nV&#39;.</span>
<span class="sd">        target_units (str, optional): The target unit to convert to. Defaults to &#39;µV&#39;.</span>
<span class="sd">            Must be one of: &#39;µV&#39;, &#39;mV&#39;, &#39;V&#39;, &#39;nV&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The multiplication factor to convert from current_units to target_units.</span>
<span class="sd">            To convert values, multiply your data by this factor.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If current_units or target_units are not supported.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; convert_units_to_multiplier(&quot;mV&quot;, &quot;µV&quot;)</span>
<span class="sd">        1000.0</span>
<span class="sd">        &gt;&gt;&gt; convert_units_to_multiplier(&quot;V&quot;, &quot;mV&quot;)</span>
<span class="sd">        1000.0</span>
<span class="sd">        &gt;&gt;&gt; convert_units_to_multiplier(&quot;µV&quot;, &quot;V&quot;)</span>
<span class="sd">        1e-06</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">units_to_mult</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;µV&quot;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="s2">&quot;mV&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;nV&quot;</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">}</span>

    <span class="k">assert</span> <span class="n">current_units</span> <span class="ow">in</span> <span class="n">units_to_mult</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;No valid current unit called &#39;</span><span class="si">{</span><span class="n">current_units</span><span class="si">}</span><span class="s2">&#39; found&quot;</span>
    <span class="k">assert</span> <span class="n">target_units</span> <span class="ow">in</span> <span class="n">units_to_mult</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;No valid target unit called &#39;</span><span class="si">{</span><span class="n">target_units</span><span class="si">}</span><span class="s2">&#39; found&quot;</span>

    <span class="k">return</span> <span class="n">units_to_mult</span><span class="p">[</span><span class="n">current_units</span><span class="p">]</span> <span class="o">/</span> <span class="n">units_to_mult</span><span class="p">[</span><span class="n">target_units</span><span class="p">]</span></div>



<div class="viewcode-block" id="extract_mne_unit_info">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.extract_mne_unit_info">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_mne_unit_info</span><span class="p">(</span><span class="n">raw_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract unit information from MNE Raw info object.</span>

<span class="sd">    Args:</span>
<span class="sd">        raw_info (dict): MNE Raw.info object containing channel information</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[str | None, float | None]: (unit_name, mult_to_uV) where unit_name</span>
<span class="sd">                                        is the consistent unit across all channels</span>
<span class="sd">                                        and mult_to_uV is the conversion factor to µV</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If channel units are inconsistent across channels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mne</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">FIFF</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;MNE not available, cannot extract unit information&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s2">&quot;chs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">raw_info</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">raw_info</span><span class="p">[</span><span class="s2">&quot;chs&quot;</span><span class="p">]:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No channel information found in MNE Raw.info, using default units&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># Extract unit information from all channels</span>
    <span class="n">channel_units</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unit_muls</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ch_info</span> <span class="ow">in</span> <span class="n">raw_info</span><span class="p">[</span><span class="s2">&quot;chs&quot;</span><span class="p">]:</span>
        <span class="n">ch_name</span> <span class="o">=</span> <span class="n">ch_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ch_name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">ch_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">unit_mul</span> <span class="o">=</span> <span class="n">ch_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit_mul&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">unit_mul</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">channel_units</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ch_name</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">unit_mul</span><span class="p">))</span>
            <span class="n">unit_muls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit_mul</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">channel_units</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No unit information found in any channels, using default units&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># Check for consistency in unit values</span>
    <span class="n">unique_units</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">unit</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">channel_units</span><span class="p">)</span>
    <span class="n">unique_unit_muls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">unit_muls</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_units</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">unit_details</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ch</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">mul</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">mul</span> <span class="ow">in</span> <span class="n">channel_units</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Inconsistent units across channels. Found different unit values: </span><span class="si">{</span><span class="n">unique_units</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Channel details: </span><span class="si">{</span><span class="n">unit_details</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_unit_muls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">unit_details</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ch</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">mul</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">mul</span> <span class="ow">in</span> <span class="n">channel_units</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Inconsistent unit multipliers across channels. Found different unit_mul values: </span><span class="si">{</span><span class="n">unique_unit_muls</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Channel details: </span><span class="si">{</span><span class="n">unit_details</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Get the consistent unit values</span>
    <span class="n">unit_code</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_units</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">unit_mul</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_unit_muls</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Convert MNE unit codes to string representation using FIFF constants</span>
    <span class="c1"># Based on MNE FIFF constants documentation</span>
    <span class="n">unit_str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">FIFF</span><span class="p">,</span> <span class="s2">&quot;FIFF_UNIT_V&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">unit_code</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_V</span><span class="p">:</span>
        <span class="n">unit_str</span> <span class="o">=</span> <span class="s2">&quot;V&quot;</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">FIFF</span><span class="p">,</span> <span class="s2">&quot;FIFF_UNIT_T&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">unit_code</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_T</span><span class="p">:</span>
        <span class="n">unit_str</span> <span class="o">=</span> <span class="s2">&quot;T&quot;</span>  <span class="c1"># Tesla - MEG magnetometer</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">FIFF</span><span class="p">,</span> <span class="s2">&quot;FIFF_UNIT_T_M&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">unit_code</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_T_M</span><span class="p">:</span>
        <span class="n">unit_str</span> <span class="o">=</span> <span class="s2">&quot;T/m&quot;</span>  <span class="c1"># Tesla/meter - MEG gradiometer</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown MNE unit code </span><span class="si">{</span><span class="n">unit_code</span><span class="si">}</span><span class="s2">, using default units&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># Convert unit multipliers using FIFF constants</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">FIFF</span><span class="p">,</span> <span class="s2">&quot;FIFF_UNITM_NONE&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">unit_mul</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNITM_NONE</span><span class="p">:</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">FIFF</span><span class="p">,</span> <span class="s2">&quot;FIFF_UNITM_MU&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">unit_mul</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNITM_MU</span><span class="p">:</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1e-6</span>  <span class="c1"># micro</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">FIFF</span><span class="p">,</span> <span class="s2">&quot;FIFF_UNITM_M&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">unit_mul</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNITM_M</span><span class="p">:</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1e-3</span>  <span class="c1"># milli</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">FIFF</span><span class="p">,</span> <span class="s2">&quot;FIFF_UNITM_N&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">unit_mul</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNITM_N</span><span class="p">:</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1e-9</span>  <span class="c1"># nano</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">FIFF</span><span class="p">,</span> <span class="s2">&quot;FIFF_UNITM_P&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">unit_mul</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNITM_P</span><span class="p">:</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1e-12</span>  <span class="c1"># pico</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">FIFF</span><span class="p">,</span> <span class="s2">&quot;FIFF_UNITM_F&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">unit_mul</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNITM_F</span><span class="p">:</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1e-15</span>  <span class="c1"># femto</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback to numerical interpretation if FIFF constants not available</span>
        <span class="n">mul_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># FIFF_UNITM_NONE</span>
            <span class="o">-</span><span class="mi">3</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>  <span class="c1"># FIFF_UNITM_M (milli)</span>
            <span class="o">-</span><span class="mi">6</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>  <span class="c1"># FIFF_UNITM_MU (micro)</span>
            <span class="o">-</span><span class="mi">9</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span>  <span class="c1"># FIFF_UNITM_N (nano)</span>
            <span class="o">-</span><span class="mi">12</span><span class="p">:</span> <span class="mf">1e-12</span><span class="p">,</span>  <span class="c1"># FIFF_UNITM_P (pico)</span>
            <span class="o">-</span><span class="mi">15</span><span class="p">:</span> <span class="mf">1e-15</span><span class="p">,</span>  <span class="c1"># FIFF_UNITM_F (femto)</span>
        <span class="p">}</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="n">mul_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">unit_mul</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">multiplier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown MNE unit multiplier </span><span class="si">{</span><span class="n">unit_mul</span><span class="si">}</span><span class="s2">, using default units&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># For EEG data (voltage units), compute the final unit and conversion factor</span>
    <span class="k">if</span> <span class="n">unit_str</span> <span class="o">==</span> <span class="s2">&quot;V&quot;</span><span class="p">:</span>
        <span class="c1"># Apply the MNE multiplier to get the actual unit</span>
        <span class="k">if</span> <span class="n">multiplier</span> <span class="o">==</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="n">final_unit</span> <span class="o">=</span> <span class="s2">&quot;µV&quot;</span>
        <span class="k">elif</span> <span class="n">multiplier</span> <span class="o">==</span> <span class="mf">1e-3</span><span class="p">:</span>
            <span class="n">final_unit</span> <span class="o">=</span> <span class="s2">&quot;mV&quot;</span>
        <span class="k">elif</span> <span class="n">multiplier</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">final_unit</span> <span class="o">=</span> <span class="s2">&quot;V&quot;</span>
        <span class="k">elif</span> <span class="n">multiplier</span> <span class="o">==</span> <span class="mf">1e-9</span><span class="p">:</span>
            <span class="n">final_unit</span> <span class="o">=</span> <span class="s2">&quot;nV&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unusual voltage unit multiplier </span><span class="si">{</span><span class="n">multiplier</span><span class="si">}</span><span class="s2">, treating as V&quot;</span><span class="p">)</span>
            <span class="n">final_unit</span> <span class="o">=</span> <span class="s2">&quot;V&quot;</span>

        <span class="c1"># Convert to µV multiplier using existing utility</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mult_to_uV</span> <span class="o">=</span> <span class="n">convert_units_to_multiplier</span><span class="p">(</span><span class="n">final_unit</span><span class="p">,</span> <span class="s2">&quot;µV&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted MNE units: </span><span class="si">{</span><span class="n">final_unit</span><span class="si">}</span><span class="s2"> -&gt; mult_to_uV = </span><span class="si">{</span><span class="n">mult_to_uV</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">final_unit</span><span class="p">,</span> <span class="n">mult_to_uV</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to convert units </span><span class="si">{</span><span class="n">final_unit</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Non-voltage units (MEG, etc.) - don&#39;t convert to µV</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Non-voltage units detected: </span><span class="si">{</span><span class="n">unit_str</span><span class="si">}</span><span class="s2">, not converting to µV&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="is_day">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.is_day">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_day</span><span class="p">(</span><span class="n">dt</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">sunrise</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sunset</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a datetime object is during the day.</span>

<span class="sd">    Args:</span>
<span class="sd">        dt (datetime): Datetime object to check</span>
<span class="sd">        sunrise (int, optional): Sunrise hour (0-23). Defaults to 6.</span>
<span class="sd">        sunset (int, optional): Sunset hour (0-23). Defaults to 18.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the datetime is during the day, False otherwise</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If dt is not a datetime object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected datetime object, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sunrise</span> <span class="o">&lt;=</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="n">sunset</span></div>



<div class="viewcode-block" id="convert_colpath_to_rowpath">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.convert_colpath_to_rowpath">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_colpath_to_rowpath</span><span class="p">(</span>
    <span class="n">rowdir_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">col_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">gzip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">aspath</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a ColMajor file path to its corresponding RowMajor file path.</span>

<span class="sd">    This function transforms file paths from column-major format to row-major format,</span>
<span class="sd">    which is used when converting between different data storage layouts in Neurodent.</span>

<span class="sd">    Args:</span>
<span class="sd">        rowdir_path (str | Path): Directory path where the RowMajor file should be located.</span>
<span class="sd">        col_path (str | Path): Path to the ColMajor file to be converted. Must contain &#39;ColMajor&#39; in the path.</span>
<span class="sd">        gzip (bool, optional): If True, append &#39;.npy.gz&#39; extension. If False, append &#39;.bin&#39;. Defaults to True.</span>
<span class="sd">        aspath (bool, optional): If True, return as Path object. If False, return as string. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str | Path: The converted RowMajor file path, either as string or Path object based on aspath parameter.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If &#39;ColMajor&#39; is not found in col_path.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; convert_colpath_to_rowpath(&quot;/data/row/&quot;, &quot;/data/col/file_ColMajor_001.bin&quot;)</span>
<span class="sd">        PosixPath(&#39;/data/row/file_RowMajor_001.npy.gz&#39;)</span>
<span class="sd">        &gt;&gt;&gt; convert_colpath_to_rowpath(&quot;/data/row/&quot;, &quot;/data/col/file_ColMajor_001.bin&quot;, gzip=False)</span>
<span class="sd">        PosixPath(&#39;/data/row/file_RowMajor_001.bin&#39;)</span>
<span class="sd">        &gt;&gt;&gt; convert_colpath_to_rowpath(&quot;/data/row/&quot;, &quot;/data/col/file_ColMajor_001.bin&quot;, aspath=False)</span>
<span class="sd">        &#39;/data/row/file_RowMajor_001.npy.gz&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO it would make more sense to not have a rowdir_path aparameter, since this is outside the scope of the function</span>
    <span class="k">if</span> <span class="s2">&quot;ColMajor&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col_path</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected &#39;ColMajor&#39; in col_path: </span><span class="si">{</span><span class="n">col_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">rowdir_path</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">get_file_stem</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">col_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ColMajor&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;RowMajor&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">gzip</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.npy.gz&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.bin&quot;</span>
    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="k">if</span> <span class="n">aspath</span> <span class="k">else</span> <span class="n">out</span></div>



<div class="viewcode-block" id="filepath_to_index">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.filepath_to_index">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">filepath_to_index</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the index number from a filepath.</span>

<span class="sd">    This function extracts the last number found in a filepath after removing common suffixes</span>
<span class="sd">    and file extensions. For example, from &quot;/path/to/data_ColMajor_001.bin&quot; it returns 1.</span>

<span class="sd">    Args:</span>
<span class="sd">        filepath (str | Path): Path to the file to extract index from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The extracted index number.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; filepath_to_index(&quot;/path/to/data_ColMajor_001.bin&quot;)</span>
<span class="sd">        1</span>
<span class="sd">        &gt;&gt;&gt; filepath_to_index(&quot;/path/to/data_2023_015_ColMajor.bin&quot;)</span>
<span class="sd">        15</span>
<span class="sd">        &gt;&gt;&gt; filepath_to_index(&quot;/path/to/data_Meta_010.json&quot;)</span>
<span class="sd">        10</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fpath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;_RowMajor&quot;</span><span class="p">,</span> <span class="s2">&quot;_ColMajor&quot;</span><span class="p">,</span> <span class="s2">&quot;_Meta&quot;</span><span class="p">]:</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Remove only the actual file extension, not dots within the filename</span>
    <span class="n">path_obj</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path_obj</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path_obj</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">))</span>

    <span class="n">fname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\D+&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fname</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>



<div class="viewcode-block" id="parse_truncate">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.parse_truncate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_truncate</span><span class="p">(</span><span class="n">truncate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse the truncate parameter to determine how many characters to truncate.</span>

<span class="sd">    If truncate is a boolean, returns 10 if True and 0 if False.</span>
<span class="sd">    If truncate is an integer, returns that integer value directly.</span>

<span class="sd">    Args:</span>
<span class="sd">        truncate (int | bool): If bool, True=10 chars and False=0 chars.</span>
<span class="sd">                              If int, specifies exact number of chars.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: Number of characters to truncate (0 means no truncation)</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If truncate is not a boolean or integer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">truncate</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">10</span> <span class="k">if</span> <span class="n">truncate</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">truncate</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">truncate</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid truncate value: </span><span class="si">{</span><span class="n">truncate</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="nanaverage">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.nanaverage">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">nanaverage</span><span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute weighted average of an array, ignoring NaN values.</span>

<span class="sd">    This function computes a weighted average along the specified axis while</span>
<span class="sd">    properly handling NaN values by masking them out of the calculation.</span>

<span class="sd">    Args:</span>
<span class="sd">        A (np.ndarray): Input array containing the values to average.</span>
<span class="sd">        weights (np.ndarray): Array of weights corresponding to the values in A.</span>
<span class="sd">            Must be broadcastable with A along the specified axis.</span>
<span class="sd">        axis (int, optional): Axis along which to compute the average. Defaults to -1 (last axis).</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Weighted average with NaN values properly handled. If all values</span>
<span class="sd">            along an axis are NaN, the result will be NaN for that position.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; A = np.array([[1.0, 2.0, np.nan], [4.0, np.nan, 6.0]])</span>
<span class="sd">        &gt;&gt;&gt; weights = np.array([1, 2, 1])</span>
<span class="sd">        &gt;&gt;&gt; nanaverage(A, weights, axis=1)</span>
<span class="sd">        array([1.66666667, 5.        ])</span>

<span class="sd">    Note:</span>
<span class="sd">        Be careful with zero or negative weights as they may produce unexpected results.</span>
<span class="sd">        The function uses numpy&#39;s masked array functionality for robust NaN handling.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">masked</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>

    <span class="c1"># Handle case where np.ma.average returns a scalar instead of masked array</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">avg</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">avg</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># avg is a scalar or regular array, convert to array and handle NaN</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">avg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">result</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span></div>



<div class="viewcode-block" id="parse_path_to_animalday">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.parse_path_to_animalday">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_path_to_animalday</span><span class="p">(</span>
    <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">animal_param</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="n">day_sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;nest&quot;</span><span class="p">,</span> <span class="s2">&quot;concat&quot;</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="s2">&quot;noday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;concat&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">day_parse_kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the filename of a binfolder to get the animalday identifier (animal id, genotype, and day).</span>

<span class="sd">    Args:</span>
<span class="sd">        filepath (str | Path): Filepath of the binfolder.</span>
<span class="sd">        animal_param (tuple[int, str] | str | list[str], optional): Parameter specifying how to parse the animal ID:</span>
<span class="sd">            tuple[int, str]: (index, separator) for simple split and index</span>
<span class="sd">            str: regex pattern to extract ID</span>
<span class="sd">            list[str]: list of possible animal IDs to match against</span>
<span class="sd">        day_sep (str, optional): Separator for day in filename. Defaults to None.</span>
<span class="sd">        mode (Literal[&#39;nest&#39;, &#39;concat&#39;, &#39;base&#39;, &#39;noday&#39;], optional): Mode to parse the filename. Defaults to &#39;concat&#39;.</span>

<span class="sd">            - &#39;nest&#39;: Extracts genotype/animal from parent directory name and date from filename.</span>
<span class="sd">              Example: &quot;/WT_A10/recording_2023-04-01.*&quot;</span>
<span class="sd">            - &#39;concat&#39;: Extracts all info from filename, expects genotype_animal_date format.</span>
<span class="sd">              Example: &quot;/WT_A10_2023-04-01.*&quot;</span>
<span class="sd">            - &#39;base&#39;: Same as concat</span>
<span class="sd">            - &#39;noday&#39;: Extracts only genotype and animal ID, uses default date.</span>
<span class="sd">              Example: &quot;/WT_A10_recording.*&quot;</span>
<span class="sd">        **day_parse_kwargs: Additional keyword arguments to pass to parse_str_to_day function.</span>
<span class="sd">                           Common options include parse_params dict for dateutil.parser.parse.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[str, str]: Dictionary with keys &quot;animal&quot;, &quot;genotype&quot;, &quot;day&quot;, and &quot;animalday&quot; (concatenated).</span>
<span class="sd">            Example: {&quot;animal&quot;: &quot;A10&quot;, &quot;genotype&quot;: &quot;WT&quot;, &quot;day&quot;: &quot;Apr-01-2023&quot;, &quot;animalday&quot;: &quot;A10 WT Apr-01-2023&quot;}</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If mode is invalid or required components cannot be extracted</span>
<span class="sd">        TypeError: If filepath is not str or Path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">match</span> <span class="n">mode</span><span class="p">:</span>
        <span class="k">case</span> <span class="s2">&quot;nest&quot;</span><span class="p">:</span>
            <span class="n">geno</span> <span class="o">=</span> <span class="n">parse_str_to_genotype</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">animid</span> <span class="o">=</span> <span class="n">parse_str_to_animal</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">animal_param</span><span class="o">=</span><span class="n">animal_param</span><span class="p">)</span>
            <span class="n">day</span> <span class="o">=</span> <span class="n">parse_str_to_day</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">day_sep</span><span class="p">,</span> <span class="o">**</span><span class="n">day_parse_kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%b-</span><span class="si">%d</span><span class="s2">-%Y&quot;</span><span class="p">)</span>
        <span class="k">case</span> <span class="s2">&quot;concat&quot;</span> <span class="o">|</span> <span class="s2">&quot;base&quot;</span><span class="p">:</span>
            <span class="n">geno</span> <span class="o">=</span> <span class="n">parse_str_to_genotype</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">animid</span> <span class="o">=</span> <span class="n">parse_str_to_animal</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">animal_param</span><span class="o">=</span><span class="n">animal_param</span><span class="p">)</span>
            <span class="n">day</span> <span class="o">=</span> <span class="n">parse_str_to_day</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">day_sep</span><span class="p">,</span> <span class="o">**</span><span class="n">day_parse_kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%b-</span><span class="si">%d</span><span class="s2">-%Y&quot;</span><span class="p">)</span>
        <span class="k">case</span> <span class="s2">&quot;noday&quot;</span><span class="p">:</span>
            <span class="n">geno</span> <span class="o">=</span> <span class="n">parse_str_to_genotype</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">animid</span> <span class="o">=</span> <span class="n">parse_str_to_animal</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">animal_param</span><span class="o">=</span><span class="n">animal_param</span><span class="p">)</span>
            <span class="n">day</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">DEFAULT_DAY</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%b-</span><span class="si">%d</span><span class="s2">-%Y&quot;</span><span class="p">)</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;animal&quot;</span><span class="p">:</span> <span class="n">animid</span><span class="p">,</span>
        <span class="s2">&quot;genotype&quot;</span><span class="p">:</span> <span class="n">geno</span><span class="p">,</span>
        <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">day</span><span class="p">,</span>
        <span class="s2">&quot;animalday&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">animid</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">geno</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">day</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="parse_str_to_genotype">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.parse_str_to_genotype">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_str_to_genotype</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strict_matching</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the filename of a binfolder to get the genotype.</span>

<span class="sd">    Args:</span>
<span class="sd">        string (str): String to parse.</span>
<span class="sd">        strict_matching (bool, optional): If True, ensures the input matches exactly one genotype.</span>
<span class="sd">            If False, allows overlapping matches and uses longest. Defaults to False for</span>
<span class="sd">            backward compatibility.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Genotype.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: When string cannot be parsed or contains ambiguous matches in strict mode.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; parse_str_to_genotype(&quot;WT_A10_data&quot;)</span>
<span class="sd">        &#39;WT&#39;</span>
<span class="sd">        &gt;&gt;&gt; parse_str_to_genotype(&quot;WT_KO_comparison&quot;, strict_matching=True)  # Would raise error</span>
<span class="sd">        ValueError: Ambiguous match...</span>
<span class="sd">        &gt;&gt;&gt; parse_str_to_genotype(&quot;WT_KO_comparison&quot;, strict_matching=False)  # Uses longest match</span>
<span class="sd">        &#39;WT&#39;  # or &#39;KO&#39; depending on which alias is longer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_get_key_from_match_values</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">GENOTYPE_ALIASES</span><span class="p">,</span> <span class="n">strict_matching</span><span class="p">)</span></div>



<div class="viewcode-block" id="parse_str_to_animal">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.parse_str_to_animal">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_str_to_animal</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">animal_param</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the filename of a binfolder to get the animal id.</span>

<span class="sd">    Args:</span>
<span class="sd">        string (str): String to parse.</span>
<span class="sd">        animal_param: Parameter specifying how to parse the animal ID:</span>
<span class="sd">            tuple[int, str]: (index, separator) for simple split and index. Not recommended for inconsistent naming conventions.</span>
<span class="sd">            str: regex pattern to extract ID. Most general use case. If multiple matches are found, returns the first match.</span>
<span class="sd">            list[str]: list of possible animal IDs to match against. Returns first match in list order, case-sensitive, ignoring empty strings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Animal id.</span>

<span class="sd">    Examples:</span>
<span class="sd">        # Tuple format: (index, separator)</span>
<span class="sd">        &gt;&gt;&gt; parse_str_to_animal(&quot;WT_A10_2023-01-01_data.bin&quot;, (1, &quot;_&quot;))</span>
<span class="sd">        &#39;A10&#39;</span>
<span class="sd">        &gt;&gt;&gt; parse_str_to_animal(&quot;A10_WT_recording.bin&quot;, (0, &quot;_&quot;))</span>
<span class="sd">        &#39;A10&#39;</span>

<span class="sd">        # Regex pattern format</span>
<span class="sd">        &gt;&gt;&gt; parse_str_to_animal(&quot;WT_A10_2023-01-01_data.bin&quot;, r&quot;A\\d+&quot;)</span>
<span class="sd">        &#39;A10&#39;</span>
<span class="sd">        &gt;&gt;&gt; parse_str_to_animal(&quot;subject_123_data.bin&quot;, r&quot;\\d+&quot;)</span>
<span class="sd">        &#39;123&#39;</span>

<span class="sd">        # List format: possible IDs to match</span>
<span class="sd">        &gt;&gt;&gt; parse_str_to_animal(&quot;WT_A10_2023-01-01_data.bin&quot;, [&quot;A10&quot;, &quot;A11&quot;, &quot;A12&quot;])</span>
<span class="sd">        &#39;A10&#39;</span>
<span class="sd">        &gt;&gt;&gt; parse_str_to_animal(&quot;WT_A10_data.bin&quot;, [&quot;B15&quot;, &quot;C20&quot;])  # No match</span>
<span class="sd">        ValueError: No matching ID found in WT_A10_data.bin from possible IDs: [&#39;B15&#39;, &#39;C20&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">animal_param</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">index</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="n">animal_param</span>
        <span class="n">animid</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">animid</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">animal_param</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">animal_param</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No match found for pattern </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2"> in string </span><span class="si">{</span><span class="n">string</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">animal_param</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">possible_ids</span> <span class="o">=</span> <span class="n">animal_param</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">possible_ids</span><span class="p">:</span>
            <span class="c1"># Skip empty or whitespace-only strings</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">and</span> <span class="nb">id</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">id</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No matching ID found in </span><span class="si">{</span><span class="n">string</span><span class="si">}</span><span class="s2"> from possible IDs: </span><span class="si">{</span><span class="n">possible_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid animal_param type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">animal_param</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="parse_str_to_day">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.parse_str_to_day">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_str_to_day</span><span class="p">(</span>
    <span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parse_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parse_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="s2">&quot;window&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;split&quot;</span><span class="p">,</span>
    <span class="n">date_patterns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the filename of a binfolder to get the day.</span>

<span class="sd">    Args:</span>
<span class="sd">        string (str): String to parse.</span>
<span class="sd">        sep (str, optional): Separator to split string by. If None, split by whitespace. Defaults to None.</span>
<span class="sd">        parse_params (dict, optional): Parameters to pass to dateutil.parser.parse. Defaults to {&#39;fuzzy&#39;:True}.</span>
<span class="sd">        parse_mode (Literal[&quot;full&quot;, &quot;split&quot;, &quot;window&quot;, &quot;all&quot;], optional): Mode for parsing the string. Defaults to &quot;split&quot;.</span>
<span class="sd">            &quot;full&quot;: Try parsing the entire cleaned string only</span>
<span class="sd">            &quot;split&quot;: Try parsing individual tokens only</span>
<span class="sd">            &quot;window&quot;: Try parsing sliding windows of tokens (2-4 tokens) only</span>
<span class="sd">            &quot;all&quot;: Use all three approaches in the order &quot;full&quot;, &quot;split&quot;, &quot;window</span>
<span class="sd">        date_patterns (list[tuple[str, str]], optional): List of (regex_pattern, strptime_format) tuples</span>
<span class="sd">            to try before falling back to token-based parsing. This allows users to specify</span>
<span class="sd">            exact formats to handle ambiguous cases like MM/DD/YYYY vs DD/MM/YYYY.</span>
<span class="sd">            Only used in &quot;split&quot; and &quot;all&quot; modes. Defaults to None (no regex patterns).</span>

<span class="sd">    Returns:</span>
<span class="sd">        datetime: Datetime object corresponding to the day of the binfolder.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If no valid date token is found in the string.</span>
<span class="sd">        TypeError: If date_patterns is not a list of tuples.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Handle ambiguous date formats with explicit patterns</span>
<span class="sd">        &gt;&gt;&gt; patterns = [(r&#39;(19\d{2}|20\d{2})-(\d{1,2})-(\d{1,2})&#39;, &#39;%Y-%m-%d&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; parse_str_to_day(&#39;2001_2023-07-04_data&#39;, date_patterns=patterns)</span>
<span class="sd">        datetime.datetime(2023, 7, 4, 0, 0)</span>

<span class="sd">        &gt;&gt;&gt; # European format pattern</span>
<span class="sd">        &gt;&gt;&gt; patterns = [(r&#39;(\d{1,2})/(\d{1,2})/(19\d{2}|20\d{2})&#39;, &#39;%d/%m/%Y&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; parse_str_to_day(&#39;04/07/2023_data&#39;, date_patterns=patterns)</span>
<span class="sd">        datetime.datetime(2023, 7, 4, 0, 0)  # July 4th, not April 7th</span>

<span class="sd">    Note:</span>
<span class="sd">        When date_patterns is provided, users have full control over date interpretation.</span>
<span class="sd">        Without date_patterns, the function falls back to token-based parsing which may</span>
<span class="sd">        be ambiguous for formats like MM/DD/YYYY vs DD/MM/YYYY.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">parse_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">parse_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fuzzy&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parse_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;parse_params must be a dictionary&quot;</span><span class="p">)</span>

    <span class="c1"># Validate date_patterns</span>
    <span class="k">if</span> <span class="n">date_patterns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date_patterns</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;date_patterns must be a list of (regex_pattern, strptime_format) tuples&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pattern_tuple</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">date_patterns</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern_tuple</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">pattern_tuple</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;date_patterns[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] must be a tuple of (regex_pattern, strptime_format)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;date_patterns[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] must contain string elements&quot;</span><span class="p">)</span>

    <span class="c1"># Validate parse_mode</span>
    <span class="n">valid_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="s2">&quot;window&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">parse_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_modes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid parse_mode: </span><span class="si">{</span><span class="n">parse_mode</span><span class="si">}</span><span class="s2">. Must be one of </span><span class="si">{</span><span class="n">valid_modes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">clean_str</span> <span class="o">=</span> <span class="n">_clean_str_for_date</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

    <span class="c1"># Only use user-provided regex patterns for &quot;split&quot; and &quot;all&quot; modes</span>
    <span class="k">if</span> <span class="n">date_patterns</span> <span class="ow">and</span> <span class="n">parse_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]:</span>
        <span class="n">date_result</span> <span class="o">=</span> <span class="n">_try_user_regex_patterns</span><span class="p">(</span><span class="n">clean_str</span><span class="p">,</span> <span class="n">date_patterns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">date_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">date_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Warn when patterns are provided but none match, falling back to token parsing</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No user-provided date patterns matched &#39;</span><span class="si">{</span><span class="n">clean_str</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Falling back to token-based parsing which may be ambiguous.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Fallback to original token-based approach</span>
    <span class="c1"># Try parsing based on the specified mode</span>
    <span class="k">if</span> <span class="n">parse_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]:</span>
        <span class="c1"># Pass 1: Try parsing the entire cleaned string</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">clean_str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">DEFAULT_DAY</span><span class="p">,</span> <span class="o">**</span><span class="n">parse_params</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;</span> <span class="mi">1980</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">date</span>
        <span class="k">except</span> <span class="n">ParserError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">parse_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]:</span>
        <span class="c1"># Pass 2: Try individual tokens</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">clean_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Only 1 string token found. Did you mean to use a different separator or parse_mode=&#39;all&#39;?&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># logging.debug(f&#39;token: {token}&#39;)</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">DEFAULT_DAY</span><span class="p">,</span> <span class="o">**</span><span class="n">parse_params</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="mi">1980</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">return</span> <span class="n">date</span>
            <span class="k">except</span> <span class="n">ParserError</span><span class="p">:</span>
                <span class="k">continue</span>

    <span class="k">if</span> <span class="n">parse_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;window&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]:</span>
        <span class="c1"># Pass 3: Try sliding window of tokens</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">clean_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Only 1 string token found. Did you mean to use a different separator or parse_mode=&#39;all&#39;?&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">window_size</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">grouped</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">date</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">grouped</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">DEFAULT_DAY</span><span class="p">,</span> <span class="o">**</span><span class="n">parse_params</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="mi">1980</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">return</span> <span class="n">date</span>
                <span class="k">except</span> <span class="n">ParserError</span><span class="p">:</span>
                    <span class="k">continue</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid date token found in string: </span><span class="si">{</span><span class="n">string</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_try_user_regex_patterns</span><span class="p">(</span><span class="n">clean_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">date_patterns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try user-provided regex patterns to find complete date patterns.</span>

<span class="sd">    Args:</span>
<span class="sd">        clean_str (str): Cleaned string to search for date patterns</span>
<span class="sd">        date_patterns (list[tuple[str, str]]): List of (regex_pattern, strptime_format) tuples</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[datetime]: Parsed datetime if a pattern matches, None otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">successful_matches</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">pattern_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">date_format</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">date_patterns</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">regex_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">clean_str</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">regex_matches</span><span class="p">:</span>
                <span class="n">date_str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c1"># Check if date string can be parsed and meets year criteria</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_str</span><span class="p">,</span> <span class="n">date_format</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;</span> <span class="mi">1980</span><span class="p">:</span>
                        <span class="n">successful_matches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">date_str</span><span class="p">,</span> <span class="n">pattern_idx</span><span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">continue</span>
        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid regex pattern &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Check for multiple successful matches and warn</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">match_details</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;pattern </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: &#39;</span><span class="si">{</span><span class="n">match</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">match</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">successful_matches</span><span class="p">]</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Multiple date patterns matched in &#39;</span><span class="si">{</span><span class="n">clean_str</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">match_details</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Using first match: &#39;</span><span class="si">{</span><span class="n">successful_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
            <span class="ne">UserWarning</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Return first successful match</span>
    <span class="k">if</span> <span class="n">successful_matches</span><span class="p">:</span>
        <span class="n">first_match_str</span><span class="p">,</span> <span class="n">first_pattern_idx</span> <span class="o">=</span> <span class="n">successful_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pattern</span><span class="p">,</span> <span class="n">date_format</span> <span class="o">=</span> <span class="n">date_patterns</span><span class="p">[</span><span class="n">first_pattern_idx</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">first_match_str</span><span class="p">,</span> <span class="n">date_format</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_clean_str_for_date</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clean a string by removing common non-date tokens and patterns.</span>

<span class="sd">    Args:</span>
<span class="sd">        string (str): Input string containing date</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Cleaned string with non-date tokens removed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patterns</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">DATEPARSER_PATTERNS_TO_REMOVE</span>
    <span class="n">combined_pattern</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">combined_pattern</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleaned</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">cleaned</span>


<div class="viewcode-block" id="parse_chname_to_abbrev">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.parse_chname_to_abbrev">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_chname_to_abbrev</span><span class="p">(</span><span class="n">channel_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">assume_from_number</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict_matching</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the channel name to get the abbreviation.</span>

<span class="sd">    Args:</span>
<span class="sd">        channel_name (str): Name of the channel.</span>
<span class="sd">        assume_from_number (bool, optional): If True, assume the abbreviation based on the last number</span>
<span class="sd">            in the channel name when normal parsing fails. Defaults to False.</span>
<span class="sd">        strict_matching (bool, optional): If True, ensures the input matches exactly one L/R alias and</span>
<span class="sd">            one channel alias. If False, allows multiple matches and uses longest. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Abbreviation of the channel name.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: When channel_name cannot be parsed or contains ambiguous matches in strict mode.</span>
<span class="sd">        KeyError: When assume_from_number=True but the detected number is not a valid channel ID.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; parse_chname_to_abbrev(&quot;left Aud&quot;)</span>
<span class="sd">        &#39;LAud&#39;</span>
<span class="sd">        &gt;&gt;&gt; parse_chname_to_abbrev(&quot;Right VIS&quot;)</span>
<span class="sd">        &#39;RVis&#39;</span>
<span class="sd">        &gt;&gt;&gt; parse_chname_to_abbrev(&quot;channel_9&quot;, assume_from_number=True)</span>
<span class="sd">        &#39;LAud&#39;</span>
<span class="sd">        &gt;&gt;&gt; parse_chname_to_abbrev(&quot;LRAud&quot;, strict_matching=False)  # Would work in non-strict mode</span>
<span class="sd">        &#39;LAud&#39;  # Uses longest L/R match</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">channel_name</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">DEFAULT_ID_TO_NAME</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">channel_name</span><span class="si">}</span><span class="s2"> is already an abbreviation&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channel_name</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">_get_key_from_match_values</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">LR_ALIASES</span><span class="p">,</span> <span class="n">strict_matching</span><span class="p">)</span>
        <span class="n">chname</span> <span class="o">=</span> <span class="n">_get_key_from_match_values</span><span class="p">(</span><span class="n">channel_name</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">CHNAME_ALIASES</span><span class="p">,</span> <span class="n">strict_matching</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">assume_from_number</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">channel_name</span><span class="si">}</span><span class="s2"> does not match name aliases. Assuming alias from number in channel name.&quot;</span><span class="p">)</span>
            <span class="n">nums</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">channel_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">nums</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected to find a number in channel name &#39;</span><span class="si">{</span><span class="n">channel_name</span><span class="si">}</span><span class="s2">&#39; when assume_from_number=True, but no numbers were found.&quot;</span>
                <span class="p">)</span>

            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">DEFAULT_ID_TO_NAME</span><span class="p">:</span>
                <span class="n">available_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">DEFAULT_ID_TO_NAME</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Channel number </span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2"> found in &#39;</span><span class="si">{</span><span class="n">channel_name</span><span class="si">}</span><span class="s2">&#39; is not a valid channel ID. Available channel IDs: </span><span class="si">{</span><span class="n">available_ids</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">constants</span><span class="o">.</span><span class="n">DEFAULT_ID_TO_NAME</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">return</span> <span class="n">lr</span> <span class="o">+</span> <span class="n">chname</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_get_key_from_match_values</span><span class="p">(</span><span class="n">input_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">alias_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">strict_matching</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the best matching key from alias dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_string (str): String to search in</span>
<span class="sd">        alias_dict (dict): Dictionary of {key: [aliases]} to match against</span>
<span class="sd">        strict_matching (bool): If True, ensures only one alias matches across all keys</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The key with the best matching alias</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: When no matches found or multiple matches in strict mode</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">candidate</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">aliases</span> <span class="ow">in</span> <span class="n">alias_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">aliases</span>
        <span class="k">if</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">input_string</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">alias_examples</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">aliases</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">aliases</span> <span class="ow">in</span> <span class="n">alias_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>  <span class="c1"># Show first 2 aliases per key</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">input_string</span><span class="si">}</span><span class="s2"> does not have any matching values. Available aliases (examples): </span><span class="si">{</span><span class="n">alias_examples</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">strict_matching</span><span class="p">:</span>
        <span class="c1"># Check if multiple different keys match</span>
        <span class="n">matching_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">matched_aliases</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">alias</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">matches</span> <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">matching_keys</span><span class="p">}</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Ambiguous match in &#39;</span><span class="si">{</span><span class="n">input_string</span><span class="si">}</span><span class="s2">&#39;. Multiple alias types matched: </span><span class="si">{</span><span class="n">matched_aliases</span><span class="si">}</span><span class="s2">. Use strict_matching=False to allow ambiguous matches.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Return the key with the longest matching alias</span>
    <span class="n">best_match_key</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">best_match_key</span>


<div class="viewcode-block" id="set_temp_directory">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.set_temp_directory">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">set_temp_directory</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the temporary directory for Neurodent operations.</span>

<span class="sd">    This function configures the temporary directory used by Neurodent for intermediate</span>
<span class="sd">    files and operations. The directory will be created if it doesn&#39;t exist.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str | Path): Path to the temporary directory. Will be created if it doesn&#39;t exist.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; set_temp_directory(&quot;/tmp/neurodent_temp&quot;)</span>
<span class="sd">        &gt;&gt;&gt; set_temp_directory(Path.home() / &quot;neurodent_workspace&quot; / &quot;temp&quot;)</span>

<span class="sd">    Note:</span>
<span class="sd">        This function modifies the TMPDIR environment variable, which affects</span>
<span class="sd">        the behavior of other temporary file operations in the process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TMPDIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temporary directory set to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_temp_directory">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.get_temp_directory">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_temp_directory</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the current temporary directory used by Neurodent.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path: Path object representing the current temporary directory.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; temp_dir = get_temp_directory()</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Current temp directory: {temp_dir}&quot;)</span>
<span class="sd">        Current temp directory: /tmp/neurodent_temp</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If TMPDIR environment variable is not set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TMPDIR&quot;</span><span class="p">])</span></div>



<div class="viewcode-block" id="cache_fragments_to_zarr">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.cache_fragments_to_zarr">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cache_fragments_to_zarr</span><span class="p">(</span>
    <span class="n">np_fragments</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n_fragments</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;zarr.Array&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cache numpy fragments array to zarr format for efficient memory management.</span>

<span class="sd">    This function converts a numpy array of recording fragments to a zarr array stored</span>
<span class="sd">    in a temporary location. This allows better memory management and garbage collection</span>
<span class="sd">    by avoiding keeping large numpy arrays in memory for extended periods.</span>

<span class="sd">    Args:</span>
<span class="sd">        np_fragments (np.ndarray): Numpy array of shape (n_fragments, n_samples, n_channels)</span>
<span class="sd">            containing the recording fragments to cache.</span>
<span class="sd">        n_fragments (int): Number of fragments to cache (allows for subset caching).</span>
<span class="sd">        tmpdir (str, optional): Directory path for temporary zarr storage. If None,</span>
<span class="sd">            uses get_temp_directory(). Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[str, zarr.Array]: A tuple containing:</span>
<span class="sd">            - str: Path to the temporary zarr file</span>
<span class="sd">            - zarr.Array: The zarr array object for accessing cached data</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: If zarr is not available</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;zarr package is required for fragment caching&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tmpdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">get_temp_directory</span><span class="p">()</span>

    <span class="c1"># Generate unique temporary path</span>
    <span class="n">tmppath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;temp_</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">.zarr&quot;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Caching numpy array with zarr in </span><span class="si">{</span><span class="n">tmppath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create Zarr array with optimal settings for fragment-wise access</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_fragments</span><span class="p">)</span>  <span class="c1"># Cap at 100 fragments per chunk</span>
    <span class="n">zarr_array</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
        <span class="n">tmppath</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="n">np_fragments</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">chunks</span><span class="o">=</span><span class="p">(</span>
            <span class="n">chunk_size</span><span class="p">,</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># No chunking along timestamp dimension</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># No chunking along channel dimension</span>
        <span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np_fragments</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">compressor</span><span class="o">=</span><span class="n">zarr</span><span class="o">.</span><span class="n">Blosc</span><span class="p">(</span><span class="n">cname</span><span class="o">=</span><span class="s2">&quot;lz4&quot;</span><span class="p">,</span> <span class="n">clevel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">zarr</span><span class="o">.</span><span class="n">Blosc</span><span class="o">.</span><span class="n">SHUFFLE</span><span class="p">),</span>  <span class="c1"># Fast compression</span>
    <span class="p">)</span>
    <span class="n">zarr_array</span><span class="p">[:</span><span class="n">n_fragments</span><span class="p">]</span> <span class="o">=</span> <span class="n">np_fragments</span><span class="p">[:</span><span class="n">n_fragments</span><span class="p">]</span>

    <span class="c1"># Log debug properties of the zarr array</span>
    <span class="n">total_memory_bytes</span> <span class="o">=</span> <span class="n">zarr_array</span><span class="o">.</span><span class="n">nbytes</span>
    <span class="n">total_memory_mb</span> <span class="o">=</span> <span class="n">total_memory_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
    <span class="n">total_memory_gb</span> <span class="o">=</span> <span class="n">total_memory_mb</span> <span class="o">/</span> <span class="mi">1024</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Total memory footprint: </span><span class="si">{</span><span class="n">total_memory_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB, </span><span class="si">{</span><span class="n">total_memory_gb</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GB&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Zarr array shape: </span><span class="si">{</span><span class="n">zarr_array</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Zarr array chunks: </span><span class="si">{</span><span class="n">zarr_array</span><span class="o">.</span><span class="n">chunks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tmppath</span><span class="p">,</span> <span class="n">zarr_array</span></div>



<div class="viewcode-block" id="get_file_stem">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.get_file_stem">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_file_stem</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the true stem for files, handling double extensions like .npy.gz.&quot;&quot;&quot;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">name</span>

    <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_get_groupby_keys</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">groupby</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the unique values of the groupby variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_pairwise_combinations</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all pairwise combinations of a list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_HiddenPrints</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager to suppress print output during code execution.</span>

<span class="sd">    This class provides a way to temporarily suppress print statements and other</span>
<span class="sd">    stdout output, which is useful when calling functions that produce unwanted</span>
<span class="sd">    console output.</span>

<span class="sd">    Args:</span>
<span class="sd">        silence (bool, optional): Whether to actually suppress output. Defaults to True.</span>
<span class="sd">            If False, acts as a no-op context manager.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; with _HiddenPrints():</span>
<span class="sd">        ...     print(&quot;This won&#39;t be displayed&quot;)</span>
<span class="sd">        ...     some_noisy_function()</span>
<span class="sd">        &gt;&gt;&gt; print(&quot;This will be displayed&quot;)</span>
<span class="sd">        This will be displayed</span>

<span class="sd">        &gt;&gt;&gt; with _HiddenPrints(silence=False):</span>
<span class="sd">        ...     print(&quot;This will be displayed&quot;)</span>
<span class="sd">        This will be displayed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">silence</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silence</span> <span class="o">=</span> <span class="n">silence</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_stdout</span>


<div class="viewcode-block" id="nanmean_series_of_np">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.nanmean_series_of_np">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">nanmean_series_of_np</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Efficiently compute NaN-aware mean of a pandas Series containing numpy arrays.</span>

<span class="sd">    This function is optimized for computing the mean across a Series where each element</span>
<span class="sd">    is a numpy array. It uses different strategies based on the size of the Series</span>
<span class="sd">    for optimal performance.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (pd.Series): Series containing numpy arrays as elements.</span>
<span class="sd">        axis (int, optional): Axis along which to compute the mean. Defaults to 0.</span>
<span class="sd">            - axis=0: Mean across the Series elements (most common)</span>
<span class="sd">            - axis=1: Mean within each array element</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Array containing the computed means with NaN values properly handled.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; # Create a Series of numpy arrays</span>
<span class="sd">        &gt;&gt;&gt; arrays = [np.array([1.0, 2.0, np.nan]),</span>
<span class="sd">        ...           np.array([4.0, np.nan, 6.0]),</span>
<span class="sd">        ...           np.array([7.0, 8.0, 9.0])]</span>
<span class="sd">        &gt;&gt;&gt; series = pd.Series(arrays)</span>
<span class="sd">        &gt;&gt;&gt; nanmean_series_of_np(series)</span>
<span class="sd">        array([4. , 5. , 7.5])</span>

<span class="sd">    Performance Notes:</span>
<span class="sd">        - For Series with more than 1000 elements containing numpy arrays,</span>
<span class="sd">          uses `np.stack()` for better performance</span>
<span class="sd">        - Falls back to list conversion for smaller Series or mixed types</span>
<span class="sd">        - Handles shape mismatches gracefully by falling back to the slower method</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># logging.debug(f&quot;Unique shapes in x: {set(np.shape(item) for item in x)}&quot;)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">xmean</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">xmean</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="n">xmean</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xmean</span></div>



<div class="viewcode-block" id="log_transform">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.log_transform">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">log_transform</span><span class="p">(</span><span class="n">rec</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log transform the signal</span>

<span class="sd">    Args:</span>
<span class="sd">        rec (np.ndarray): The signal to log transform.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: ln(rec + 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="sort_dataframe_by_plot_order">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.sort_dataframe_by_plot_order">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sort_dataframe_by_plot_order</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_sort_order</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sort DataFrame columns according to predefined orders.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame to sort</span>
<span class="sd">    df_sort_order : dict</span>
<span class="sd">        Dictionary mapping column names to the order of the values in the column.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Sorted DataFrame</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If df_sort_order is not a valid dictionary or contains invalid categories</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">df_sort_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df_sort_order</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">DF_SORT_ORDER</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_sort_order</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;df_sort_order must be a dictionary&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">categories</span> <span class="ow">in</span> <span class="n">df_sort_order</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Categories for column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; must be a list or tuple&quot;</span><span class="p">)</span>

    <span class="n">columns_to_sort</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_sort_order</span><span class="p">]</span>
    <span class="n">df_sorted</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">columns_to_sort</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df_sorted</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns_to_sort</span><span class="p">:</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="n">df_sort_order</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

        <span class="c1"># Check for values not in predefined categories</span>
        <span class="n">unique_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_sorted</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">missing_values</span> <span class="o">=</span> <span class="n">unique_values</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">missing_values</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; contains values not in sort order dictionary: </span><span class="si">{</span><span class="n">missing_values</span><span class="si">}</span><span class="s2">. Add them to plot_order in ExperimentPlotter init.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Filter categories to only include those that exist in the DataFrame</span>
        <span class="n">existing_categories</span> <span class="o">=</span> <span class="p">[</span><span class="n">cat</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">categories</span> <span class="k">if</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">unique_values</span><span class="p">]</span>

        <span class="n">df_sorted</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df_sorted</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">existing_categories</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">df_sorted</span> <span class="o">=</span> <span class="n">df_sorted</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">columns_to_sort</span><span class="p">)</span>
    <span class="c1"># REVIEW since &quot;sex&quot; is not inherently part of the pipeline (add ad-hoc), this could be a feature worth sorting</span>
    <span class="c1"># But this might mean rewriting the data loading pipeline, file-reading, etc.</span>
    <span class="c1"># Maybe a dictionary corresponding to animal/id -&gt; sex would be good enough, instead of reading it in from filenames</span>
    <span class="c1"># which would be difficult since name conventions are not standardized</span>

    <span class="k">return</span> <span class="n">df_sorted</span></div>



<div class="viewcode-block" id="Natural_Neighbor">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.Natural_Neighbor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Natural_Neighbor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Natural Neighbor algorithm implementation for finding natural neighbors in a dataset.</span>

<span class="sd">    This class implements the Natural Neighbor algorithm which finds mutual neighbors</span>
<span class="sd">    in a dataset by iteratively expanding the neighborhood radius until convergence.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Natural_Neighbor.__init__">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.Natural_Neighbor.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Natural Neighbor algorithm.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            nan_edges (dict): Graph of mutual neighbors</span>
<span class="sd">            nan_num (dict): Number of natural neighbors for each instance</span>
<span class="sd">            repeat (dict): Data structure that counts repetitions of the count method</span>
<span class="sd">            target (list): Set of classes</span>
<span class="sd">            data (list): Set of instances</span>
<span class="sd">            knn (dict): Structure that stores neighbors of each instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nan_edges</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Graph of mutual neighbors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nan_num</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Number of natural neighbors for each instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Data structure that counts repetitions of the count method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Set of classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Set of instances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knn</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Structure that stores neighbors of each instance</span></div>


<div class="viewcode-block" id="Natural_Neighbor.load">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.Natural_Neighbor.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load dataset from a CSV file, separating attributes and classes.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): Path to the CSV file containing the dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">inst_class</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inst_class</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inst</span><span class="p">]</span>
                <span class="n">aux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span></div>


<div class="viewcode-block" id="Natural_Neighbor.read">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.Natural_Neighbor.read">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load data directly from a numpy array.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (np.ndarray): Input data array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span></div>


<div class="viewcode-block" id="Natural_Neighbor.asserts">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.Natural_Neighbor.asserts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">asserts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize data structures for the algorithm.</span>

<span class="sd">        Sets up the necessary data structures including:</span>
<span class="sd">        - nan_edges as an empty set</span>
<span class="sd">        - knn, nan_num, and repeat dictionaries for each instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nan_edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">knn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nan_num</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="Natural_Neighbor.count">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.Natural_Neighbor.count">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of instances that have no natural neighbors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Number of instances with zero natural neighbors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nan_zeros</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nan_num</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nan_num</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nan_zeros</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">nan_zeros</span></div>


<div class="viewcode-block" id="Natural_Neighbor.findKNN">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.Natural_Neighbor.findKNN">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">findKNN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the indices of the k nearest neighbors.</span>

<span class="sd">        Args:</span>
<span class="sd">            inst: Instance to find neighbors for</span>
<span class="sd">            r (int): Radius/parameter for neighbor search</span>
<span class="sd">            tree: KDTree object for efficient neighbor search</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Array of neighbor indices (excluding the instance itself)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">inst</span><span class="p">],</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="Natural_Neighbor.algorithm">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.Natural_Neighbor.algorithm">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">algorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the Natural Neighbor algorithm.</span>

<span class="sd">        The algorithm iteratively expands the neighborhood radius until convergence,</span>
<span class="sd">        finding mutual neighbors between instances.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The final radius value when convergence is reached</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize KDTree for efficient neighbor search</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asserts</span><span class="p">()</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">while</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
                <span class="n">knn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findKNN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r</span><span class="p">,</span> <span class="n">tree</span><span class="p">)</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">knn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">knn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knn</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nan_edges</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nan_edges</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nan_edges</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nan_num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nan_num</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="n">rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rep</span> <span class="o">&gt;=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">rep</span><span class="p">):</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">r</span></div>
</div>



<div class="viewcode-block" id="TimestampMapper">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.TimestampMapper">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TimestampMapper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map each fragment to its source file&#39;s timestamp.</span>

<span class="sd">    This class provides functionality to map data fragments back to their original</span>
<span class="sd">    file timestamps when data has been concatenated from multiple files with</span>
<span class="sd">    different recording times.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        file_end_datetimes (list[datetime]): The end datetimes of each source file.</span>
<span class="sd">        file_durations (list[float]): The durations of each source file in seconds.</span>
<span class="sd">        file_start_datetimes (list[datetime]): Computed start datetimes of each file.</span>
<span class="sd">        cumulative_durations (np.ndarray): Cumulative sum of file durations.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from datetime import datetime, timedelta</span>
<span class="sd">        &gt;&gt;&gt; # Set up files with known end times and durations</span>
<span class="sd">        &gt;&gt;&gt; end_times = [datetime(2023, 1, 1, 12, 0), datetime(2023, 1, 1, 13, 0)]</span>
<span class="sd">        &gt;&gt;&gt; durations = [3600.0, 1800.0]  # 1 hour, 30 minutes</span>
<span class="sd">        &gt;&gt;&gt; mapper = TimestampMapper(end_times, durations)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Get timestamp for fragment at index 2 with 60s fragments</span>
<span class="sd">        &gt;&gt;&gt; timestamp = mapper.get_fragment_timestamp(2, 60.0)</span>
<span class="sd">        &gt;&gt;&gt; print(timestamp)</span>
<span class="sd">        2023-01-01 11:02:00</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TimestampMapper.__init__">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.TimestampMapper.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_end_datetimes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">datetime</span><span class="p">],</span> <span class="n">file_durations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the TimestampMapper.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_end_datetimes (list[datetime]): The end datetimes of each file.</span>
<span class="sd">            file_durations (list[float]): The durations of each file in seconds.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the lengths of file_end_datetimes and file_durations don&#39;t match.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_end_datetimes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_durations</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;file_end_datetimes and file_durations must have the same length&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file_end_datetimes</span> <span class="o">=</span> <span class="n">file_end_datetimes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_durations</span> <span class="o">=</span> <span class="n">file_durations</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file_start_datetimes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">file_end_datetime</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">file_duration</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file_end_datetime</span><span class="p">,</span> <span class="n">file_duration</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_end_datetimes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_durations</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_durations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_durations</span><span class="p">)</span></div>


<div class="viewcode-block" id="TimestampMapper.get_fragment_timestamp">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.TimestampMapper.get_fragment_timestamp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fragment_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragment_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">fragment_len_s</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the timestamp for a specific fragment based on its index and length.</span>

<span class="sd">        Args:</span>
<span class="sd">            fragment_idx (int): The index of the fragment (0-based).</span>
<span class="sd">            fragment_len_s (float): The length of each fragment in seconds.</span>

<span class="sd">        Returns:</span>
<span class="sd">            datetime: The timestamp corresponding to the start of the specified fragment.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; # Get timestamp for the 5th fragment (index 4) with 30-second fragments</span>
<span class="sd">            &gt;&gt;&gt; timestamp = mapper.get_fragment_timestamp(4, 30.0)</span>
<span class="sd">            &gt;&gt;&gt; # This returns the timestamp 2 minutes into the first file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find which file this fragment belongs to</span>
        <span class="n">fragment_start_time</span> <span class="o">=</span> <span class="n">fragment_idx</span> <span class="o">*</span> <span class="n">fragment_len_s</span>
        <span class="n">file_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cumulative_durations</span><span class="p">,</span> <span class="n">fragment_start_time</span><span class="p">)</span>
        <span class="n">file_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">file_idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cumulative_durations</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">offset_in_file</span> <span class="o">=</span> <span class="n">fragment_start_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_durations</span><span class="p">[</span><span class="n">file_idx</span><span class="p">]</span>  <span class="c1"># Negative</span>

        <span class="c1"># Return actual timestamp + offset</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_end_datetimes</span><span class="p">[</span><span class="n">file_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">offset_in_file</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="validate_timestamps">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.validate_timestamps">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_timestamps</span><span class="p">(</span><span class="n">timestamps</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">datetime</span><span class="p">],</span> <span class="n">gap_threshold_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">datetime</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate that timestamps are in chronological order and check for large gaps.</span>

<span class="sd">    Args:</span>
<span class="sd">        timestamps (list[datetime]): List of timestamps to validate</span>
<span class="sd">        gap_threshold_seconds (float, optional): Threshold in seconds for warning about large gaps. Defaults to 60.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[datetime]: The validated timestamps in chronological order</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If no valid timestamps are provided</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamps</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No timestamps provided for validation&quot;</span><span class="p">)</span>

    <span class="n">valid_timestamps</span> <span class="o">=</span> <span class="p">[</span><span class="n">ts</span> <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">timestamps</span> <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_timestamps</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">valid_timestamps</span><span class="p">)</span><span class="si">}</span><span class="s2"> None timestamps that were filtered out&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_timestamps</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid timestamps found (all were None)&quot;</span><span class="p">)</span>

    <span class="c1"># Check chronological order</span>
    <span class="n">sorted_timestamps</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">valid_timestamps</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">valid_timestamps</span> <span class="o">!=</span> <span class="n">sorted_timestamps</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Timestamps are not in chronological order. This may cause issues with the data.&quot;</span><span class="p">)</span>

    <span class="c1"># Check for large gaps between consecutive timestamps</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_timestamps</span><span class="p">)):</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="n">valid_timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">valid_timestamps</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">gap_seconds</span> <span class="o">=</span> <span class="n">gap</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">gap_seconds</span> <span class="o">&gt;</span> <span class="n">gap_threshold_seconds</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Large gap detected between timestamps: </span><span class="si">{</span><span class="n">gap</span><span class="si">}</span><span class="s2"> exceeds threshold of </span><span class="si">{</span><span class="n">gap_threshold_seconds</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">valid_timestamps</span></div>



<div class="viewcode-block" id="should_use_cached_file">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.should_use_cached_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">should_use_cached_file</span><span class="p">(</span>
    <span class="n">cache_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
    <span class="n">source_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]],</span>
    <span class="n">use_cached</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;always&quot;</span><span class="p">,</span> <span class="s2">&quot;never&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine whether to use a cached intermediate file based on caching policy and file timestamps.</span>

<span class="sd">    Args:</span>
<span class="sd">        cache_path: Path to the cached intermediate file</span>
<span class="sd">        source_paths: List of source file paths that the cache depends on</span>
<span class="sd">        use_cached: Caching policy</span>
<span class="sd">            - &quot;auto&quot;: Use cached if exists and newer than all sources (default)</span>
<span class="sd">            - &quot;always&quot;: Always use cached if it exists</span>
<span class="sd">            - &quot;never&quot;: Never use cached (always regenerate)</span>
<span class="sd">            - &quot;error&quot;: Raise error if cached doesn&#39;t exist</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if cached file should be used, False if it should be regenerated</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: When use_cached=&quot;error&quot; and cache doesn&#39;t exist</span>
<span class="sd">        ValueError: For invalid use_cached values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cache_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span>
    <span class="n">source_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">source_paths</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">use_cached</span> <span class="o">==</span> <span class="s2">&quot;never&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">use_cached</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache file required but not found: </span><span class="si">{</span><span class="n">cache_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">use_cached</span> <span class="o">==</span> <span class="s2">&quot;always&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cache_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">use_cached</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check if cache is newer than all source files</span>
        <span class="n">cache_mtime</span> <span class="o">=</span> <span class="n">cache_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>

        <span class="k">for</span> <span class="n">source_path</span> <span class="ow">in</span> <span class="n">source_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">source_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">continue</span>  <span class="c1"># Skip missing source files</span>
            <span class="k">if</span> <span class="n">source_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">&gt;</span> <span class="n">cache_mtime</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache </span><span class="si">{</span><span class="n">cache_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is older than </span><span class="si">{</span><span class="n">source_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, regenerating&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using cached intermediate file: </span><span class="si">{</span><span class="n">cache_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid use_cached value: </span><span class="si">{</span><span class="n">use_cached</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_cache_status_message">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.get_cache_status_message">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_cache_status_message</span><span class="p">(</span><span class="n">cache_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span> <span class="n">use_cached</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a descriptive message about cache usage for logging.&quot;&quot;&quot;</span>
    <span class="n">cache_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_cached</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Using cached intermediate: </span><span class="si">{</span><span class="n">cache_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Regenerating intermediate: </span><span class="si">{</span><span class="n">cache_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="should_use_cache_unified">
<a class="viewcode-back" href="../../../api/core/utils.html#neurodent.core.utils.should_use_cache_unified">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">should_use_cache_unified</span><span class="p">(</span>
    <span class="n">cache_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
    <span class="n">source_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]],</span>
    <span class="n">cache_policy</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;always&quot;</span><span class="p">,</span> <span class="s2">&quot;force_regenerate&quot;</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unified cache decision logic for all intermediate files.</span>

<span class="sd">    Args:</span>
<span class="sd">        cache_path: Path to the cache file</span>
<span class="sd">        source_paths: List of source file paths to check timestamps against</span>
<span class="sd">        cache_policy: Caching policy:</span>
<span class="sd">            - &quot;auto&quot;: Use cache if exists and newer than sources, regenerate with logging if missing/invalid</span>
<span class="sd">            - &quot;always&quot;: Use cache if exists, raise error if missing/invalid</span>
<span class="sd">            - &quot;force_regenerate&quot;: Always regenerate and overwrite existing cache</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if cache should be used, False if should regenerate</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If cache_policy is invalid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache_policy</span> <span class="o">==</span> <span class="s2">&quot;force_regenerate&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">cache_policy</span> <span class="o">==</span> <span class="s2">&quot;always&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">cache_policy</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">should_use_cached_file</span><span class="p">(</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">source_paths</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid cache_policy: </span><span class="si">{</span><span class="n">cache_policy</span><span class="si">}</span><span class="s2">. Must be one of: auto, always, force_regenerate&quot;</span><span class="p">)</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025, Joseph Dong, Yongtaek Oh, Eric Marsh.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>